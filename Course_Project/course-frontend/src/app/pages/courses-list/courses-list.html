<div class="courses-layout container py-4">

  <!-- Page Title -->
  <div class="page-header text-center mb-4">
    <h2>Course Management System</h2>
  </div>

  <!-- Search + Add Course Row -->
  <div class="d-flex justify-content-center align-items-center mb-4 flex-wrap gap-2">
    <input
      type="text"
      class="form-control"
      style="max-width: 400px;"
      placeholder="Search courses..."
      [(ngModel)]="searchTerm"
      (input)="onSearchChange()"
    />
    <button class="btn btn-primary" (click)="goToCreateCourse()">+ Add Course</button>
  </div>



  <div class="row">
    <!-- LEFT: Filters -->
    <aside class="col-12 col-md-3 mb-3">
      <div class="filters p-3 bg-white rounded shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="m-0">Filters</h5>
          <button class="btn btn-sm btn-link" (click)="clearAllFilters()">Clear</button>
        </div>

        <!-- Board (Single-select) -->
        <div class="mb-3">
          <label class="form-label small">Board</label>
          <div class="dropdown">
            <button
              class="btn btn-outline-secondary w-100 dropdown-toggle"
              type="button"
              (click)="toggleDropdown('board')"
              [attr.aria-expanded]="openBoardDropdown"
            >
              {{ selectedBoard || 'Select board' }}
            </button>
            <div class="dropdown-menu p-3" [class.show]="openBoardDropdown" style="max-height:300px; overflow:auto;">
              <button class="dropdown-item" *ngFor="let b of filterBoards" (click)="selectBoard(b)">
                {{ b }}
              </button>
            </div>
          </div>
        </div>

        <!-- Medium -->
        <div class="mb-3">
          <label class="form-label small">Medium</label>
          <div class="dropdown">
            <button
              class="btn btn-outline-secondary w-100 dropdown-toggle"
              type="button"
              (click)="toggleDropdown('medium')"
              [attr.aria-expanded]="openMediumDropdown"
            >
              {{ selectedMediums.size ? selectedMediums.size + ' selected' : 'Select medium(s)' }}
            </button>
            <div class="dropdown-menu p-3" [class.show]="openMediumDropdown" style="max-height:300px; overflow:auto;">
              <div *ngFor="let m of filterMediums" class="form-check mb-1">
                <input
                  class="form-check-input"
                  type="checkbox"
                  [id]="'medium_'+m"
                  [checked]="selectedMediums.has(m)"
                  (change)="toggleSet(selectedMediums, m)"
                />
                <label class="form-check-label" [for]="'medium_'+m">{{ m }}</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Grade -->
        <div class="mb-3">
          <label class="form-label small">Grade</label>
          <div class="dropdown">
            <button
              class="btn btn-outline-secondary w-100 dropdown-toggle"
              type="button"
              (click)="toggleDropdown('grade')"
              [attr.aria-expanded]="openGradeDropdown"
            >
              {{ selectedGrades.size ? selectedGrades.size + ' selected' : 'Select grade(s)' }}
            </button>
            <div class="dropdown-menu p-3" [class.show]="openGradeDropdown" style="max-height:300px; overflow:auto;">
              <div *ngFor="let gr of filterGrades" class="form-check mb-1">
                <input
                  class="form-check-input"
                  type="checkbox"
                  [id]="'grade_'+gr"
                  [checked]="selectedGrades.has(gr)"
                  (change)="toggleSet(selectedGrades, gr)"
                />
                <label class="form-check-label" [for]="'grade_'+gr">{{ gr }}</label>
              </div>
            </div>
          </div>
        </div>

        <!-- Subject -->
        <div class="mb-3">
          <label class="form-label small">Subject</label>
          <div class="dropdown">
            <button
              class="btn btn-outline-secondary w-100 dropdown-toggle"
              type="button"
              (click)="toggleDropdown('subject')"
              [attr.aria-expanded]="openSubjectDropdown"
            >
              {{ selectedSubjects.size ? selectedSubjects.size + ' selected' : 'Select subject(s)' }}
            </button>
            <div class="dropdown-menu p-2" [class.show]="openSubjectDropdown" style="max-height:240px; overflow:auto;">
              <div *ngFor="let s of filterSubjects" class="form-check mb-1">
                <input
                  class="form-check-input"
                  type="checkbox"
                  [id]="'subject_'+s"
                  [checked]="selectedSubjects.has(s)"
                  (change)="toggleSet(selectedSubjects, s)"
                />
                <label class="form-check-label" [for]="'subject_'+s">{{ s }}</label>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-2">
          <small class="text-muted">Showing {{ totalElements }} results</small>
        </div>
      </div>
    </aside>

    <!-- RIGHT: Cards + pagination -->
    <main class="col-12 col-md-9">
      <div *ngIf="loading" class="alert alert-info">Loading courses...</div>
      <div *ngIf="error" class="alert alert-danger">{{ error }}</div>
      <div *ngIf="!loading && courses.length === 0" class="alert alert-info">No courses found.</div>

      <div class="row g-3" *ngIf="courses.length > 0">
        <div class="col-12 col-md-6 col-lg-4" *ngFor="let course of courses">
          <div class="card h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title mb-0">{{ course.name }}</h5>
                <small class="text-muted">{{ course.board }}</small>
              </div>

              <p class="card-text text-truncate-3">{{ course.description }}</p>

              <div class="meta mb-2">
                <div><strong>Subject:</strong> {{ (course.subject || []).join(', ') || '—' }}</div>
                <div><strong>Medium:</strong> {{ (course.medium || []).join(', ') || '—' }}</div>
                <div><strong>Grade:</strong> {{ (course.grade || []).join(', ') || '—' }}</div>
              </div>

              <div class="units mb-3" *ngIf="course.units && course.units.length > 0; else noUnits">
                <strong>Units:</strong>
                <ul class="mb-0">
                  <li *ngFor="let u of course.units"><strong>{{ u.title }}</strong>: {{ u.content }}</li>
                </ul>
              </div>
              <ng-template #noUnits>
                <div class="small text-muted">No units</div>
              </ng-template>

              <div class="mt-auto d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary flex-grow-1" (click)="editCourse(course.id)">Edit</button>
                <button class="btn btn-sm btn-outline-danger" (click)="deleteCourse(course.id, course.name)">Delete</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <nav *ngIf="totalPages > 1" class="mt-4">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="page === 0">
            <a class="page-link" (click)="prevPage()" href="javascript:void(0)">Previous</a>
          </li>

          <li
            class="page-item"
            *ngFor="let i of [].constructor(totalPages); let idx = index"
            [class.active]="idx === page"
          >
            <a class="page-link" (click)="goToPage(idx)" href="javascript:void(0)">{{ idx + 1 }}</a>
          </li>

          <li class="page-item" [class.disabled]="page >= totalPages - 1">
            <a class="page-link" (click)="nextPage()" href="javascript:void(0)">Next</a>
          </li>
        </ul>
      </nav>
    </main>
  </div>
</div>
