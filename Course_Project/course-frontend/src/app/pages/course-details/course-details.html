<div class="container my-4" *ngIf="courseData as course">
  <div class="card shadow-lg border-0 rounded-4">

    <!-->  Back Button Top-Left  -->
    <button class="btn btn-secondary btn-back" (click)="goBack()">
      <i class="bi bi-arrow-left me-1"></i>Back
    </button>

    <div class="card-body">
      <!--  Course Header  -->
      <h2 class="card-title text-primary fw-bold mb-4">
        <i class="bi bi-journal-text me-2"></i>{{ course.name }}
      </h2>

      <!--  View Mode  -->
      <div *ngIf="!editMode">
        <p><i class="bi bi-card-text me-2 text-success"></i><strong>Description:</strong> {{ course.description }}</p>
        <p><i class="bi bi-building me-2 text-info"></i><strong>Board:</strong> {{ course.board }}</p>
        <p><i class="bi bi-translate me-2 text-warning"></i><strong>Mediums:</strong> {{ course.medium.join(', ') }}</p>
        <p><i class="bi bi-mortarboard me-2 text-danger"></i><strong>Grades:</strong> {{ course.grade.join(', ') }}</p>
        <p><i class="bi bi-book-half me-2 text-primary"></i><strong>Subjects:</strong> {{ course.subject.join(', ') }}</p>

        <!--  Units Section  -->
        <div class="mt-4" *ngIf="course.units && course.units.length > 0; else noUnits">
          <h5 class="fw-semibold text-primary mb-2"><i class="bi bi-diagram-3 me-2"></i>Units</h5>
          <ul class="list-group">
            <li *ngFor="let u of course.units" class="list-group-item">
              <strong>{{ u.title }}</strong>: {{ u.content }}
            </li>
          </ul>
        </div>
        <ng-template #noUnits>
          <div class="text-muted small mt-2">No units added yet.</div>
        </ng-template>
<br>
        <!--  Edit Button Bottom-Right  -->
        <button class="btn btn-primary btn-edit" (click)="toggleEdit()">
          <i class="bi bi-pencil-square me-1"></i>Edit
        </button>
      </div>

      <!--  Edit Mode  -->
      <form *ngIf="editMode" [formGroup]="courseForm" (ngSubmit)="onSave()" class="mt-3">

        <div class="mb-3">
          <label class="form-label fw-semibold"><i class="bi bi-journal-text me-2 text-primary"></i>Course Name</label>
          <input formControlName="name" type="text" class="form-control" />
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold"><i class="bi bi-card-text me-2 text-success"></i>Description</label>
          <textarea formControlName="description" class="form-control"></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label fw-semibold"><i class="bi bi-building me-2 text-info"></i>Board</label>
          <select formControlName="board" class="form-select">
            <option *ngFor="let b of boards" [value]="b">{{ b }}</option>
          </select>
        </div>

        <!--  Mediums (Multi-select dropdown)  -->
<div class="mb-3 position-relative">
  <label class="form-label fw-semibold d-block">
    <i class="bi bi-translate me-2 text-warning"></i>Mediums
  </label>
  <div class="dropdown-container">
    <div class="dropdown-toggle-btn" (click)="toggleDropdown('mediums')">
      {{ selectedMediums.length ? selectedMediums.join(', ') : 'Select Mediums' }}
      <i class="bi" [class.bi-chevron-up]="openDropdown === 'mediums'" [class.bi-chevron-down]="openDropdown !== 'mediums'"></i>
    </div>

    <div class="dropdown-panel" *ngIf="openDropdown === 'mediums'" (click)="$event.stopPropagation()">
      <div *ngFor="let m of mediums" class="form-check">
        <input
          type="checkbox"
          class="form-check-input"
          [value]="m"
          [checked]="selectedMediums.includes(m)"
          (change)="onCheckboxChange($event, 'medium')"
          id="medium-{{m}}"
        />
        <label class="form-check-label ms-2" for="medium-{{m}}">{{ m }}</label>
      </div>
    </div>
  </div>
</div>

<!--  Grades (Multi-select dropdown)  -->
<div class="mb-3 position-relative">
  <label class="form-label fw-semibold d-block">
    <i class="bi bi-mortarboard me-2 text-danger"></i>Grades
  </label>
  <div class="dropdown-container">
    <div class="dropdown-toggle-btn" (click)="toggleDropdown('grades')">
      {{ selectedGrades.length ? selectedGrades.join(', ') : 'Select Grades' }}
      <i class="bi" [class.bi-chevron-up]="openDropdown === 'grades'" [class.bi-chevron-down]="openDropdown !== 'grades'"></i>
    </div>

    <div class="dropdown-panel" *ngIf="openDropdown === 'grades'" (click)="$event.stopPropagation()">
      <div *ngFor="let g of grades" class="form-check">
        <input
          type="checkbox"
          class="form-check-input"
          [value]="g"
          [checked]="selectedGrades.includes(g)"
          (change)="onCheckboxChange($event, 'grade')"
          id="grade-{{g}}"
        />
        <label class="form-check-label ms-2" for="grade-{{g}}">{{ g }}</label>
      </div>
    </div>
  </div>
</div>

<!--  Subjects (Multi-select dropdown)  -->
<div class="mb-3 position-relative">
  <label class="form-label fw-semibold d-block">
    <i class="bi bi-book-half me-2 text-primary"></i>Subjects
  </label>
  <div class="dropdown-container">
    <div class="dropdown-toggle-btn" (click)="toggleDropdown('subjects')">
      {{ selectedSubjects.length ? selectedSubjects.join(', ') : 'Select Subjects' }}
      <i class="bi" [class.bi-chevron-up]="openDropdown === 'subjects'" [class.bi-chevron-down]="openDropdown !== 'subjects'"></i>
    </div>

    <div class="dropdown-panel" *ngIf="openDropdown === 'subjects'" (click)="$event.stopPropagation()">
      <div *ngFor="let s of subjects" class="form-check">
        <input
          type="checkbox"
          class="form-check-input"
          [value]="s"
          [checked]="selectedSubjects.includes(s)"
          (change)="onCheckboxChange($event, 'subject')"
          id="subject-{{s}}"
        />
        <label class="form-check-label ms-2" for="subject-{{s}}">{{ s }}</label>
      </div>
    </div>
  </div>
</div>


        <!--  Units Section  -->
        <div class="mt-4">
          <h5 class="text-primary fw-semibold mb-3"><i class="bi bi-diagram-3 me-2"></i>Units</h5>

          <div *ngIf="addingUnit; else addUnitButton">
            <form [formGroup]="newUnitForm" (ngSubmit)="addUnit()" class="mb-3">
              <input formControlName="title" class="form-control mb-2" placeholder="Unit Title" />
              <textarea formControlName="content" class="form-control mb-2" placeholder="Unit Content"></textarea>
              <button type="submit" class="btn btn-success btn-sm me-2">
                <i class="bi bi-check-circle me-1"></i>Save
              </button>
              <button type="button" class="btn btn-secondary btn-sm" (click)="addingUnit=false">
                <i class="bi bi-x-circle me-1"></i>Cancel
              </button>
            </form>
          </div>

          <ng-template #addUnitButton>
            <button class="btn btn-primary btn-sm mb-3" (click)="addingUnit=true">
              <i class="bi bi-plus-circle me-1"></i>Add Unit
            </button>
          </ng-template>

          <div *ngIf="units && units.length > 0; else noUnitsEdit">
            <ul class="list-group">
              <li *ngFor="let u of units; let i = index" class="list-group-item">
                <div *ngIf="editingUnitIndex !== i">
                  <strong>{{ u.title }}</strong>: {{ u.content }}
                  <div class="float-end">
                    <button class="btn btn-sm btn-primary me-2" (click)="startEditUnit(i)">
                      <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" (click)="deleteUnit(i)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>

                <!-- Inline Edit -->
                <div *ngIf="editingUnitIndex === i">
                  <form [formGroup]="unitEditForm" (ngSubmit)="saveUnitEdit()">
                    <input class="form-control mb-2" formControlName="title" />
                    <textarea class="form-control mb-2" formControlName="content"></textarea>
                    <button type="submit" class="btn btn-success btn-sm me-2">
                      <i class="bi bi-check2"></i> Save
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" (click)="cancelUnitEdit()">
                      <i class="bi bi-x-circle"></i> Cancel
                    </button>
                  </form>
                </div>
              </li>
            </ul>
          </div>

          <ng-template #noUnitsEdit>
            <div class="text-muted small">No units yet.</div>
          </ng-template>
        </div>

        <!--  Form Buttons  -->
        <div class="d-flex justify-content-center flex-wrap gap-2 mt-4">
          <button type="submit" class="btn btn-success">
            <i class="bi bi-save me-1"></i>Save
          </button>
          <button type="button" class="btn btn-secondary" (click)="onCancel()">
            <i class="bi bi-x-circle me-1"></i>Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
